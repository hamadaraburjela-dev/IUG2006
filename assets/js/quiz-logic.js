if (window.quizLogicLoaded) {
    // This is a guard to prevent the script from running multiple times.
} else {
    window.quizLogicLoaded = true;
    document.addEventListener('DOMContentLoaded', function() {
        const gateQuizData = {
            "mc_questions": [{
                "id": "gate_q1",
                "question": "أهلاً بك في الجامعة الإسلامية! للدخول، أجب عن السؤال التالي: في أي عام تأسست الجامعة؟",
                "options": {
                    "a": "1978",
                    "b": "1982",
                    "c": "1960",
                    "d": "1990"
                },
                "correctAnswer": "a",
                "hint": "تأسست الجامعة في أواخر سبعينيات القرن الماضي."
            }],
            "tf_questions": []
        };
        const admissionQuizData = {
            "tf_questions": [{
                "id": "adm_tf_q1",
                "question": "يجب على الطالب دفع رسوم طلب الالتحاق قبل تعبئة الطلب الان.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "إيصال الدفع من الدائرة المالية هو مفتاحك لبدء تعبئة الطلب عبر الإنترنت."
            }, {
                "id": "adm_tf_q2",
                "question": "يمكن للطالب تقديم طلب التحاق ورقي في مقر عمادة القبول والتسجيل.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "تواكب الجامعة التطور، لذا فكل إجراءات التقديم تتم بشكل إلكتروني."
            }, {
                "id": "adm_tf_q3",
                "question": "يتم تنسيق وقبول الطلبة في الجامعة الإسلامية بناءً على معدلاتهم في الثانوية العامة فقط، دون أي معايير أخرى.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "المنافسة تعتمد بشكل أساسي على الأداء الأكاديمي في الثانوية العامة."
            }, {
                "id": "adm_tf_q4",
                "question": "يتطلب التخرج من كلية الطب في الجامعة الإسلامية إنهاء 258 ساعة معتمدة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "دراسة الطب هي رحلة طويلة تتطلب إتمام عدد كبير جداً من الساعات المعتمدة."
            }],
            "mc_questions": [{
                "id": "adm_mc_q1",
                "question": "ما هو الحد الأدنى العام لمعدل الثانوية العامة المطلوب للتقدم للجامعة الإسلامية؟",
                "options": {
                    "a": "75%",
                    "b": "60%",
                    "c": "65%",
                    "d": "70%"
                },
                "correctAnswer": "c",
                "hint": "هذا المعدل يسمح بالتقديم العام، لكن العديد من الكليات تتطلب معدلات أعلى."
            }, {
                "id": "adm_mc_q2",
                "question": "أي من الوثائق التالية تعتبر أساسية لإتمام إجراءات تقديم طلب الالتحاق؟",
                "options": {
                    "a": "شهادة ميلاد الطالب",
                    "b": "صورة عن الهوية الشخصية",
                    "c": "استمارة رقم جلوس الثانوية العامة أو صورة عن الشهادة",
                    "d": "شهادة حسن سير وسلوك"
                },
                "correctAnswer": "c",
                "hint": "ما هي الوثيقة التي تستخدمها الجامعة للتحقق من بياناتك ومعدلك؟"
            }, {
                "id": "adm_mc_q3",
                "question": "متى تأسست الجامعة الإسلامية بغزة؟",
                "options": {
                    "a": "1985",
                    "b": "1978",
                    "c": "1990",
                    "d": "1967"
                },
                "correctAnswer": "b",
                "hint": "تأسست الجامعة في أواخر سبعينيات القرن الماضي."
            }, {
                "id": "adm_mc_q4",
                "question": "أين يمكن لطلبة محافظة خانيونس إتمام إجراءات تقديم طلب الالتحاق؟",
                "options": {
                    "a": "في المقر الرئيسي للجامعة بغزة فقط",
                    "b": "عبر الإنترنت فقط دون الحاجة لزيارة أي فرع",
                    "c": "في فرع الجامعة في خانيونس",
                    "d": "في أي مكتب بريد معتمد"
                },
                "correctAnswer": "c",
                "hint": "لتسهيل الأمر على طلبة المحافظات الجنوبية، وفرت الجامعة مقراً قريباً منهم."
            }]
        };
        const grantsQuizData = {
            "tf_questions": [{
                "id": "grants_tf_q1",
                "question": "إذا كان معدل أحد الأشقاء في كلية الطب 72%، هل يستمر في الاستفادة من منحة الأسرة؟",
                "options": {
                    "correct": "لا، ستتوقف",
                    "incorrect": "نعم، ستستمر"
                },
                "correctAnswer": "correct",
                "hint": "للاستمرارية في منحة الأسرة، يجب ألا يقل المعدل عن 75% لطلبة الطب."
            }],
            "mc_questions": [{
                "id": "grants_mc_q1",
                "question": "أنهت مريم فصلها الدراسي الأول في كلية الهندسة بتفوق، وحصلت على معدل فصلي 96% بعد أن درست 16 ساعة معتمدة. ما هي نسبة 'منحة الامتياز' التي تستحقها تلقائياً في الفصل التالي؟",
                "options": {
                    "a": "35%",
                    "b": "50%",
                    "c": "70%",
                    "d": "100%"
                },
                "correctAnswer": "c",
                "hint": "التميز العالي يكافأ بأعلى نسبة منحة تفوق متاحة (70% للمعدل الفصلي 95% فأعلى)."
            }, {
                "id": "grants_mc_q2",
                "question": "ما هي نسبة 'منحة الأسرة' التي يحصل عليها كل فرد من أسرة لديها 'شقيقان فقط' يدرسان في الجامعة؟",
                "options": {
                    "a": "15%",
                    "b": "25%",
                    "c": "30%",
                    "d": "50%"
                },
                "correctAnswer": "a",
                "hint": "عند وجود شقيقين، يحصل كل طالب منهما على منحة بنسبة 15%."
            }, {
                "id": "grants_mc_q3",
                "question": "ما هي نسبة المنحة التي يحصل عليها الطالب الذي يحفظ القرآن الكريم كاملاً بعد اجتياز امتحان التسميع؟",
                "options": {
                    "a": "35%",
                    "b": "50%",
                    "c": "70%",
                    "d": "100%"
                },
                "correctAnswer": "b",
                "hint": "الجامعة تقدر حفظة كتاب الله وتمنحهم نصف الرسوم."
            }, {
                "id": "grants_mc_q4",
                "question": "طالب حصل على معدل فصلي 92% بعد اجتياز 15 ساعة معتمدة. ما هي نسبة 'منحة الامتياز' التي يستحقها؟",
                "options": {
                    "a": "70%",
                    "b": "50%",
                    "c": "35%",
                    "d": "25%"
                },
                "correctAnswer": "c",
                "hint": "منحة الامتياز للطلبة الحاصلين على معدل فصلي من 90% إلى 94.9% هي 35%."
            }]
        };
        const exchangeQuizData = {
            "tf_questions": [{
                "id": "exc_tf_q1",
                "question": "تهتم العلاقات الخارجية في الجامعة بتوفير منح بكالوريوس، ماجستير، دكتوراه وما بعد الدكتوراه في جامعات عالمية.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "بالفعل، تعمل دائرة العلاقات الخارجية على توفير فرص متنوعة للطلبة والباحثين في جامعات عالمية مرموقة."
            }, {
                "id": "exc_tf_q2",
                "question": "الجامعة عضو في شبكة جامعات البحر الأسود وشرق البحر المتوسط (BSEMAN).",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "هذه العضوية تفتح آفاقاً للتعاون مع جامعات في منطقة البحر الأسود وشرق المتوسط."
            }, {
                "id": "exc_tf_q3",
                "question": "أبرمت العلاقات الخارجية مشاريع تبادل أكاديمي ضمن برنامج Erasmus+ مع جامعة جلاسكو وجامعة Algarve.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "برنامج Erasmus+ هو أحد أهم برامج التبادل التي تشارك فيها الجامعة."
            }, {
                "id": "exc_tf_q4",
                "question": "تعتبر الجامعة الإسلامية عضواً في اتحاد جامعات البحر الأبيض المتوسط.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "الجامعة عضو في العديد من الهيئات الدولية مما يعزز مكانتها العالمية."
            }],
            "mc_questions": [{
                "id": "exc_mc_q1",
                "question": "أياً من الخدمات التالية تتولّاها دائرة العلاقات الخارجية؟",
                "options": {
                    "a": "توفير منح دراسية دولية والتبادل الأكاديمي واستقطاب الباحثين",
                    "b": "تأمين المنح الدراسية فقط",
                    "c": "تنظيم الرحلات السياحية",
                    "d": "إصدار التراخيص الحكومية"
                },
                "correctAnswer": "a",
                "hint": "هذه هي المهام الأساسية للدائرة، فهي البوابة التي تربط الجامعة بالمؤسسات الأكاديمية العالمية."
            }, {
                "id": "exc_mc_q2",
                "question": "ما البرنامج الأوروبي الذي فتح المجال لتبادل أعضاء هيئة التدريس والطلبة؟",
                "options": {
                    "a": "Erasmus+ (Key Action 1)",
                    "b": "Horizon 2020",
                    "c": "Marie Skłodowska-Curie",
                    "d": "Erasmus Mundus"
                },
                "correctAnswer": "a",
                "hint": "برنامج Erasmus+ هو البرنامج الرائد في أوروبا لدعم التعليم والتدريب."
            }, {
                "id": "exc_mc_q3",
                "question": "أيٌّ مما يلي ليس من اختصاص العلاقات الخارجية بحسب الموقع؟",
                "options": {
                    "a": "قبول طلبات القبول الجامعي المحلي",
                    "b": "برامج التعاون الأكاديمي",
                    "c": "التبادل الأكاديمي",
                    "d": "بوابة الباحثين عن منح"
                },
                "correctAnswer": "a",
                "hint": "قبول الطلبة المحليين هو من اختصاص عمادة القبول والتسجيل."
            }, {
                "id": "exc_mc_q4",
                "question": "ما هو الهدف الأساسي من وجود دائرة علاقات خارجية في الجامعة؟",
                "options": {
                    "a": "تعزيز مكانة الجامعة عالمياً وفتح آفاق للتعاون الأكاديمي والبحثي",
                    "b": "تنظيم الفعاليات المحلية داخل الحرم الجامعي",
                    "c": "تسجيل الطلبة الجدد في برامج البكالوريوس",
                    "d": "الإشراف على صيانة مباني الجامعة"
                },
                "correctAnswer": "a",
                "hint": "تعمل العلاقات الخارجية كجسر بين الجامعة والعالم الخارجي في مجالات البحث العلمي والتبادل الطلابي."
            }]
        };
        const studentAffairsQuizData = {
            "tf_questions": [{
                "id": "sa_tf_q1",
                "question": "تأسست عمادة شؤون الطلبة في نفس عام تأسيس الجامعة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "تأسست الجامعة عام 1978م، بينما تأسست عمادة شؤون الطلبة بعد ذلك بثلاث سنوات في عام 1981م."
            }, {
                "id": "sa_tf_q2",
                "question": "من مهام عمادة شؤون الطلبة الإشراف على النشاط الثقافي والرياضي.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "بالتأكيد، الإشراف على الأنشطة الطلابية اللامنهجية مثل النشاط الثقافي والرياضي والفني هو جزء أساسي من عمل العمادة."
            }, {
                "id": "sa_tf_q3",
                "question": "قسم البحث الاجتماعي هو المسؤول عن ترشيح الطلبة للمنح الخارجية.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "صحيح، فبناءً على دراسة الحالة الاجتماعية والاقتصادية للطالب التي يقوم بها القسم، يتم ترشيح الطلبة للمنح والقروض."
            }, {
                "id": "sa_tf_q4",
                "question": "العمل التطوعي هو مساق اختياري يمكن للطالب التسجيل فيه.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "بالفعل، تشجع العمادة على خدمة المجتمع وتنمية مهارات الطلبة عبر مساق العمل التطوعي الاختياري."
            }],
            "mc_questions": [{
                "id": "sa_mc_q1",
                "question": "في أي عام أنشئت عمادة شؤون الطلبة؟",
                "options": {
                    "a": "1978م",
                    "b": "1981م",
                    "c": "1990م",
                    "d": "2000م"
                },
                "correctAnswer": "b",
                "hint": "تأسست العمادة عام 1981م، أي بعد ثلاث سنوات من تأسيس الجامعة."
            }, {
                "id": "sa_mc_q2",
                "question": "أي من الأقسام التالية لا يتبع لعمادة شؤون الطلبة؟",
                "options": {
                    "a": "البحث الاجتماعي",
                    "b": "النشاط الرياضي",
                    "c": "التوجيه والإرشاد",
                    "d": "القبول والتسجيل"
                },
                "correctAnswer": "d",
                "hint": "عمادة القبول والتسجيل هي عمادة مستقلة ومختصة بإجراءات قبول الطلبة وتسجيلهم الأكاديمي."
            }, {
                "id": "sa_mc_q3",
                "question": "ما هو الهدف من قسم البحث الاجتماعي بشكل أساسي؟",
                "options": {
                    "a": "مساعدة الطلبة أكاديمياً",
                    "b": "مساعدة الطلبة مالياً",
                    "c": "تنظيم الفرق الرياضية",
                    "d": "إقامة الندوات الثقافية"
                },
                "correctAnswer": "b",
                "hint": "يركز قسم البحث الاجتماعي بشكل أساسي على دراسة المشكلات الاقتصادية للطلبة وتقديم المساعدات الممكنة."
            }, {
                "id": "sa_mc_q4",
                "question": "ما هي أول خطوة يجب على الطالب اتباعها للاستفادة من خدمات البحث الاجتماعي؟",
                "options": {
                    "a": "زيارة العمادة شخصياً",
                    "b": "تعبئة استمارة إلكترونية",
                    "c": "الاتصال هاتفياً بالقسم",
                    "d": "إرسال بريد إلكتروني"
                },
                "correctAnswer": "b",
                "hint": "تبدأ معظم المعاملات الحديثة في الجامعة بخطوة رقمية، وهي تعبئة استمارة البحث الاجتماعي عبر الإنترنت."
            }]
        };
        const libraryQuizData = {
            "tf_questions": [{
                "id": "lib_tf_q1",
                "question": "يُمنع استعارة القواميس والموسوعات خارج مبنى المكتبة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "المراجع الأساسية تبقى متاحة للجميع داخل قاعة المراجع."
            }, {
                "id": "lib_tf_q2",
                "question": "تعتمد المكتبة على نظام تصنيف خاص بها غير معروف عالمياً.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "تستخدم المكتبة نظام 'تصنيف ديوي العشري' العالمي لتسهيل الوصول للكتب."
            }, {
                "id": "lib_tf_q3",
                "question": "يمكن لغير الطلبة وأعضاء هيئة التدريس الاستفادة من خدمات المكتبة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "المكتبة تخدم كافة أفراد المجتمع المحلي من مؤسسات رسمية وغير رسمية."
            }, {
                "id": "lib_tf_q4",
                "question": "تقتصر مقتنيات المكتبة على الكتب الورقية فقط.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "توفر المكتبة معرضاً إلكترونياً يضم آلاف الكتب الرقمية ورسائل الماجستير والدكتوراه."
            }],
            "mc_questions": [{
                "id": "lib_mc_q1",
                "question": "ما هو نظام التصنيف العالمي المستخدم لترتيب الكتب في المكتبة؟",
                "options": {
                    "a": "تصنيف مكتبة الكونغرس",
                    "b": "التصنيف العشري العالمي (ديوي)",
                    "c": "التصنيف الأبجدي",
                    "d": "تصنيف خاص بالجامعة"
                },
                "correctAnswer": "b",
                "hint": "هو أشهر نظام تصنيف للمكتبات في العالم ويبدأ بالأرقام."
            }, {
                "id": "lib_mc_q2",
                "question": "أي من القاعات التالية مخصصة للأبحاث الأكاديمية وكتب التراث الفلسطيني؟",
                "options": {
                    "a": "القاعة العامة",
                    "b": "قاعة المراجع والمصادر",
                    "c": "قاعة الرسائل الجامعية والفلسطينيات",
                    "d": "القاعة الإلكترونية"
                },
                "correctAnswer": "c",
                "hint": "اسم القاعة يدل على محتواها المميز من الأبحاث الأكاديمية والكتب ذات الطابع الوطني."
            }, {
                "id": "lib_mc_q3",
                "question": "أي من الخدمات التالية تعتبر خدمة إلكترونية تقدمها المكتبة عن بعد؟",
                "options": {
                    "a": "ختم الكتب",
                    "b": "خدمة 'وصل حديثًا'",
                    "c": "الإعارة اليدوية",
                    "d": "جلسات المطالعة الجماعية"
                },
                "correctAnswer": "b",
                "hint": "هي خدمة لإبقاء المستخدمين على اطلاع بآخر الإضافات لمجموعة المكتبة عبر الموقع الإلكتروني."
            }, {
                "id": "lib_mc_q4",
                "question": "ما هو الهدف الأساسي للمكتبة المركزية؟",
                "options": {
                    "a": "تحقيق الربح المادي",
                    "b": "توفير مكان هادئ للدراسة فقط",
                    "c": "بيع الكتب للطلبة",
                    "d": "خدمة العملية التعليمية وتلبية احتياجات الباحثين"
                },
                "correctAnswer": "d",
                "hint": "تعتبر المكتبة جزءاً لا يتجزأ من العملية الأكاديمية والبحثية في الجامعة."
            }]
        };
        const cafeteriaQuizData = {
            "tf_questions": [{
                "id": "caf_tf_q1",
                "question": "تقتصر خدمات الكافتيريا على بيع المشروبات الساخنة فقط.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "تقدم الكافتيريا تشكيلة واسعة من المأكولات الشعبية، السريعة، ووجبات الغداء."
            }, {
                "id": "caf_tf_q2",
                "question": "يوجد في الجامعة قسم مخصص لبيع البيتزا والمعجنات.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "بالفعل، قسم الطعام السريع يقدم البيتزا والمعجنات ومشتقاتها."
            }, {
                "id": "caf_tf_q3",
                "question": "لا تتوفر وجبات غداء متكاملة في الكافتيريا.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "قائمة طعام الغداء تشمل الشاورما، المشاوي، والسندويشات المتنوعة."
            }, {
                "id": "caf_tf_q4",
                "question": "يمكن للطلاب شراء احتياجاتهم الأساسية من الميني ماركت الموجود في الكافتيريا.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "لتسهيل حياة الطلاب، توفر الجامعة ميني ماركت داخل منطقة الكافتيريا."
            }],
            "mc_questions": [{
                "id": "caf_mc_q1",
                "question": "أي من الأطعمة التالية يصنف ضمن 'الطعام الشعبي' في كافتيريا الجامعة؟",
                "options": {
                    "a": "البيتزا",
                    "b": "الشاورما",
                    "c": "الفول والحمص",
                    "d": "الآيس كريم"
                },
                "correctAnswer": "c",
                "hint": "هو من أشهر وجبات الإفطار التقليدية في بلاد الشام."
            }, {
                "id": "caf_mc_q2",
                "question": "ما هو الهدف الأساسي من تنوع الخدمات في الكافتيريا؟",
                "options": {
                    "a": "منافسة المطاعم الخارجية",
                    "b": "الارتقاء بمستوى الخدمات المقدمة للطلاب",
                    "c": "تحقيق أرباح عالية",
                    "d": "تدريب طلاب قسم التغذية"
                },
                "correctAnswer": "b",
                "hint": "تسعى الجامعة دائمًا لتوفير أفضل تجربة لطلابها في كافة المرافق."
            }, {
                "id": "caf_mc_q3",
                "question": "إذا أراد طالب وجبة غداء سريعة، أي من الخيارات التالية هي الأنسب؟",
                "options": {
                    "a": "فلافل",
                    "b": "مشاوي",
                    "c": "آيس كريم",
                    "d": "سلطة فواكه"
                },
                "correctAnswer": "b",
                "hint": "المشاوي والشاورما هي من الخيارات الرئيسية لوجبات الغداء المتوفرة."
            }, {
                "id": "caf_mc_q4",
                "question": "بجانب المأكولات، ماذا تقدم الكافتيريا أيضًا؟",
                "options": {
                    "a": "كتب ومراجع",
                    "b": "مستلزمات رياضية",
                    "c": "حلويات ومشروبات ساخنة",
                    "d": "خدمات تصوير مستندات"
                },
                "correctAnswer": "c",
                "hint": "لا تكتمل أي وجبة بدون تحلية أو مشروب منعش."
            }]
        };
        const facultiesQuizData = {
            "tf_questions": [{
                "id": "fac_tf_q1",
                "question": "تأسست الجامعة الإسلامية بغزة عام 1978.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q2",
                "question": "الجامعة لديها 11 كلية.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q3",
                "question": "كلية الطب تأسست عام 2006.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q4",
                "question": "كلية تكنولوجيا المعلومات أُسست قبل كلية التجارة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "كانت التجارة (1981) قبل تكنولوجيا المعلومات (2005)."
            }, {
                "id": "fac_tf_q5",
                "question": "الجامعة تقدم شهادات دكتوراة (PhD) في الإدارة والاقتصاد والهندسة والفنون وتكنولوجيا المعلومات.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q6",
                "question": "الجامعة الأولى على مستوى غزة من حيث الترتيب العالمي.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q7",
                "question": "في كلية الطب، يجب على الطالب نشر بحث علمي في مجلة محكّمة كجزء من متطلبات التخرج.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q8",
                "question": "كلية الطب هي المركز الوحيد المعتمد لإجراء امتحانات IFOM داخل غزة.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q9",
                "question": "الجامعة مقرها فقط في غزة المدينة، ولا يوجد لها فروع في مناطق أخرى.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "incorrect",
                "hint": "للجامعة فروع في وسط قطاع غزة (الزهراء) وجنوبه."
            }, {
                "id": "fac_tf_q10",
                "question": "الجامعة عضو في الاتحاد الدولي للجامعات ومجموعة جامعات البحر الأبيض المتوسط.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q11",
                "question": "لدى الجامعة أكثر من 20 مركزًا ومعهدًا بحثيًا.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q12",
                "question": "تأسست كلية التربية قبل كلية الشريعة والأصول.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct",
                "hint": "التربية تأسست عام 1980، والشريعة عام 1978."
            }, {
                "id": "fac_tf_q13",
                "question": "الجامعة رائدة في خدمات البحث والتعليم في غزة منذ أكثر من 38 عامًا.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q14",
                "question": "لدى كلية الهندسة «مركز عمارة التراث – إيوان».",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q15",
                "question": "لدى كلية الهندسة «مركز تميّز للطاقة المتجددة».",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q16",
                "question": "تُصدر كلية الآداب صحيفة «صوت الجامعة».",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q17",
                "question": "من أهداف كلية الشريعة والقانون تنمية الوعي القانوني لدى المجتمع.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q18",
                "question": "تَقدُم كلية العلوم خدمةً أكاديميةً لكليات مثل الطب والهندسة والتمريض عبر تدريس مساقات وتوفير مختبرات.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q19",
                "question": "تركز كلية التمريض على الممارسة المبنية على الأدلة (Evidence-based Practices).",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }, {
                "id": "fac_tf_q20",
                "question": "كلية العلوم الصحية تسعى لإعداد كوادر صحية مختصة تلبي احتياجات المجتمع.",
                "options": {
                    "correct": "صح",
                    "incorrect": "خطأ"
                },
                "correctAnswer": "correct"
            }],
            "mc_questions": [{
                "id": "fac_mc_q1",
                "question": "كم عدد الكليات في الجامعة الإسلامية بغزة؟",
                "options": {
                    "a": "9",
                    "b": "10",
                    "c": "11",
                    "d": "12"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q2",
                "question": "أي من الكليات التالية ليست من كليات الجامعة؟",
                "options": {
                    "a": "الطب",
                    "b": "هندسة",
                    "c": "الفنون",
                    "d": "تكنولوجيا المعلومات"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q3",
                "question": "متى تأسست كلية الطب بالجامعة؟",
                "options": {
                    "a": "1980",
                    "b": "1993",
                    "c": "2005",
                    "d": "2006"
                },
                "correctAnswer": "d"
            }, {
                "id": "fac_mc_q4",
                "question": "أي من التالي يصف مكانة الجامعة على مستوى غزة؟",
                "options": {
                    "a": "الثالثة",
                    "b": "الرابعة",
                    "c": "الثانية",
                    "d": "الأولى"
                },
                "correctAnswer": "d"
            }, {
                "id": "fac_mc_q5",
                "question": "في أي كلية يجب على الطالب اجتياز امتحاني IFOM-BSE وIFOM-CSE للتخرج؟",
                "options": {
                    "a": "الهندسة",
                    "b": "الطب",
                    "c": "تكنولوجيا المعلومات",
                    "d": "التربية"
                },
                "correctAnswer": "b"
            }, {
                "id": "fac_mc_q6",
                "question": "من بين هذه الكليات، أيها تأسست أولاً؟",
                "options": {
                    "a": "تكنولوجيا المعلومات (2005)",
                    "b": "التجارة (1981)",
                    "c": "التربية (1980)",
                    "d": "الطب (2006)"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q7",
                "question": "أي من الاتحادات التالية الجامعة عضو فيها؟",
                "options": {
                    "a": "رابطة الجامعات الأمريكية",
                    "b": "رابطة الجامعات الإسلامية",
                    "c": "اتحاد جامعات البحر الأبيض المتوسط",
                    "d": "رابطة الجامعات الصينية"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q8",
                "question": "كم عدد المراكز والمعاهد البحثية المرفوعة؟",
                "options": {
                    "a": "أقل من 10",
                    "b": "حوالي 15",
                    "c": "أكثر من 20",
                    "d": "30 فقط"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q9",
                "question": "ما السنة التي تقدّمت فيها الجامعة 304 مرتبة في الترتيب العالمي (Webometrics)؟",
                "options": {
                    "a": "2020",
                    "b": "2021",
                    "c": "2022",
                    "d": "2023"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q10",
                "question": "ما الترتيب العربي للجامعة حسب Webometrics؟",
                "options": {
                    "a": "50",
                    "b": "77",
                    "c": "100",
                    "d": "125"
                },
                "correctAnswer": "b"
            }, {
                "id": "fac_mc_q11",
                "question": "الجامعة توصّلت إلى شراكة بحثية مع...؟",
                "options": {
                    "a": "جامعة هارفارد",
                    "b": "جامعة لندن للعلوم",
                    "c": "معهد التربية بجامعة UCL",
                    "d": "جامعة كامبريدج"
                },
                "correctAnswer": "c"
            }, {
                "id": "fac_mc_q12",
                "question": "أي من التالي ليس من كليات الجامعة؟",
                "options": {
                    "a": "الفنون",
                    "b": "أصول الدين",
                    "c": "الهندسة",
                    "d": "التجارة"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q13",
                "question": "أي من التالي يشكّل جزءًا من أهداف كلية الطب؟",
                "options": {
                    "a": "إعداد أطباء تلبية لاحتياجات المجتمع",
                    "b": "إعداد مهندسين مدنيين",
                    "c": "تطوير برامج الإدارة فقط",
                    "d": "نشر الفكر الفلسفي فقط"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q14",
                "question": "من كان أول عميد لكلية الطب في الجامعة الإسلامية بغزة؟",
                "options": {
                    "a": "د. مفيد المخللاتي",
                    "b": "د. فاضل نعيم",
                    "c": "د. أنور شيخ خليل",
                    "d": "د. نصر المزين"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q15",
                "question": "أي من التالي يعبّر عن وصف الجامعة بأنها 'بيت الطالب الفلسطيني'؟",
                "options": {
                    "a": "جامعة فلسطينية خاصة",
                    "b": "جامعة مستقلة عريقة في خدمة الطلبة الفلسطينيين",
                    "c": "مؤسسة تعليمية فقط",
                    "d": "كلية تقنية فقط"
                },
                "correctAnswer": "b"
            }, {
                "id": "fac_mc_q16",
                "question": "أي كلية تضم برنامج «هندسة النظم الذكية»؟",
                "options": {
                    "a": "كلية تكنولوجيا المعلومات",
                    "b": "كلية الهندسة",
                    "c": "كلية العلوم",
                    "d": "كلية الآداب"
                },
                "correctAnswer": "b"
            }, {
                "id": "fac_mc_q17",
                "question": "أي المسارات التالية موجود ضمن «هندسة النظم الذكية»؟",
                "options": {
                    "a": "أنظمة الطاقة الذكية",
                    "b": "هندسة الطيران",
                    "c": "هندسة البترول",
                    "d": "هندسة الطب الحيوي"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q18",
                "question": "أيٌّ مما يلي يُعد مسارًا ضمن برنامج الهندسة المعمارية؟",
                "options": {
                    "a": "تصميم داخلي",
                    "b": "هندسة البحار",
                    "c": "الهندسة الطبية",
                    "d": "الكيمياء الحيوية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q19",
                "question": "أي درجة دكتوراه تُطرح في كلية الهندسة؟",
                "options": {
                    "a": "دكتوراه هندسة الحاسوب",
                    "b": "دكتوراه طب الأسنان",
                    "c": "دكتوراه الإعلام",
                    "d": "دكتوراه الترجمة"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q20",
                "question": "أيٌّ من المختبرات التالية مُدرج ضمن مختبرات قسم الهندسة الكهربائية؟",
                "options": {
                    "a": "مختبر المعالجات والمتحكمات الدقيقة",
                    "b": "مختبر الأحياء الدقيقة",
                    "c": "مختبر التشريح",
                    "d": "مختبر الصحافة التلفزيونية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q21",
                "question": "أي برنامج «بكالوريوس» يوجد في كلية الآداب؟",
                "options": {
                    "a": "الإعلام الرقمي",
                    "b": "هندسة الذكاء الاصطناعي",
                    "c": "التمريض",
                    "d": "الطب البشري"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q22",
                "question": "أي مسمّى صحيح لتخصص ضمن «الصحافة والإعلام» بكلية الآداب؟",
                "options": {
                    "a": "علاقات عامة وإعلان",
                    "b": "تصميم ميكاترونيكس",
                    "c": "هندسة كيميائية",
                    "d": "نظم معلومات صحية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q23",
                "question": "أي خيار يُمثّل فرعيًا موجودًا في قسم اللغة العربية بكلية الآداب؟",
                "options": {
                    "a": "تدقيق لغوي",
                    "b": "جراحة عامة",
                    "c": "هندسة موانئ",
                    "d": "فيزياء طبية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q24",
                "question": "أي «مساق» وارد في خطة برنامج اللغة الإنجليزية/فرعي ترجمة (سنة رابعة – فصل ثانٍ)؟",
                "options": {
                    "a": "الترجمة الفورية",
                    "b": "فيزياء الكم",
                    "c": "تشريح الإنسان",
                    "d": "مقاومة المواد"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q25",
                "question": "أي مركز يتبع كلية الآداب؟",
                "options": {
                    "a": "مركز التاريخ الشفوي والتراث الفلسطيني",
                    "b": "مركز طب المناطق الحارة",
                    "c": "مركز تحلية المياه",
                    "d": "مركز الذكاء الاصطناعي الطبي"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q26",
                "question": "أيٌّ من الآتي «برنامج/تخصص» بكالوريوس في كلية العلوم؟",
                "options": {
                    "a": "التكنولوجيا الحيوية",
                    "b": "هندسة البترول",
                    "c": "طب الأسنان",
                    "d": "علوم سياسية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q27",
                "question": "أي عبارة صحيحة تخص قسم الرياضيات بكلية العلوم؟",
                "options": {
                    "a": "أطلق أول برنامج دكتوراه في الرياضيات بقطاع غزة عام 2014",
                    "b": "لا يطرح برامج دراسات عليا",
                    "c": "أول ماجستير بدأ عام 2022",
                    "d": "يمنح فقط بكالوريوس"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q28",
                "question": "أين يقع «الفرع الرئيس» للجامعة بحسب الصفحة الرسمية؟",
                "options": {
                    "a": "شارع الثلاثيني – حي الرمال – غزة",
                    "b": "خان يونس",
                    "c": "رفح",
                    "d": "دير البلح"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q29",
                "question": "أي خدمة/منصة تظهر ضمن روابط الخدمات الإلكترونية في الواجهة الرئيسية للموقع؟",
                "options": {
                    "a": "Moodle",
                    "b": "Coursera",
                    "c": "edX",
                    "d": "Khan Academy"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q30",
                "question": "أي خبر جامعي نُشر بتاريخ 9 أغسطس 2025؟",
                "options": {
                    "a": "حصول الجامعة على اعتماد لافتتاح برنامج هندسة الذكاء الاصطناعي",
                    "b": "افتتاح مكتبة الطب",
                    "c": "تخريج دفعة 2026",
                    "d": "اعتماد برنامج طب الأسنان"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q31",
                "question": "أي عبارة صحيحة عن كلية الهندسة؟",
                "options": {
                    "a": "تضم قسم هندسة الحاسوب وتطرح له خطة دراسية وبـرنـامج ماجستير",
                    "b": "لا تضم أي أقسام للحاسوب",
                    "c": "لا تملك مختبرات",
                    "d": "لا تقدم دراسات عليا"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q32",
                "question": "أيٌّ من التالي برنامج داخل كلية تكنولوجيا المعلومات؟",
                "options": {
                    "a": "الذكاء الاصطناعي وعلوم البيانات",
                    "b": "إدارة المستشفيات",
                    "c": "العلوم السياسية",
                    "d": "الصيدلة"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q33",
                "question": "أي من «المساقات» التالية يندرج ضمن برنامج اللغة الإنجليزية/صحافة وإعلام أو فرعي ترجمة (كلية الآداب)؟",
                "options": {
                    "a": "الترجمة التجارية والأكاديمية",
                    "b": "مقاومة المواد",
                    "c": "تشريح مقارن",
                    "d": "أساسيات الدوائر الكهربائية"
                },
                "correctAnswer": "a"
            }, {
                "id": "fac_mc_q34",
                "question": "أيٌّ مما يلي يعدّ «برنامج ماجستير» مذكورًا تحت كلية الآداب؟",
                "options": {
                    "a": "ماجستير الصحافة",
                    "b": "ماجستير هندسة الميكاترونيكس",
                    "c": "ماجستير التحاليل الطبية",
                    "d": "ماجستير طب الفم والأسنان"
                },
                "correctAnswer": "a"
            }]
        };
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizModalBtn = document.getElementById('close-quiz-modal-btn');
        const quizBody = document.getElementById('quiz-body');
        const quizTitleEl = document.getElementById('quiz-title');
        const feedbackPopup = document.getElementById('feedback-popup');
        const feedbackEmoji = document.getElementById('feedback-emoji');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackHint = document.getElementById('feedback-hint');
        const feedbackContent = feedbackPopup ? feedbackPopup.querySelector('.feedback-popup-content') : null;
        const correctSound = document.getElementById('correct-sound');
        const incorrectSound = document.getElementById('incorrect-sound');
        const transitionSound = document.getElementById('transition-sound');
        const guideAppearsSound = document.getElementById('guide-appears-sound');
        const successSound = document.getElementById('badge-sound');
        let isAudioUnlocked = false;
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let helpCounters = {};
        let questionTimer;
        let timeLeft = 0;
        const TIME_PER_QUESTION = 25;
        const TIME_ADDITION = 30;
        const FEEDBACK_DURATION = 5000;
        const NUM_QUESTIONS_TO_SHOW = 10;
        let quizRestartAttempts = 1;
        
                // Use page filename as stable quizId (e.g., library, grants, ...)
                currentQuizId = (location.pathname.split('/').pop() || 'index.html').replace(/\.html?$/,'').toLowerCase();
let currentQuizData = null;
        let currentQuizTitle = '';
        const mapScene = document.getElementById('map-scene');

        function initializeQuiz(triggerButtonId, quizDataObject, quizTitle) {
            const startQuizBtn = document.getElementById(triggerButtonId);
            if (!startQuizBtn) return;
            const startQuiz = () => {
                currentQuizData = quizDataObject;
                currentQuizTitle = quizTitle;
                unlockAudio();
                if (quizTitleEl) quizTitleEl.textContent = quizTitle;
                currentQuestionIndex = 0;
                score = 0;
                quizRestartAttempts = 1;
                
                // Use page filename as stable quizId (e.g., library, grants, ...)
                currentQuizId = (location.pathname.split('/').pop() || 'index.html').replace(/\.html?$/,'').toLowerCase();
helpCounters = {
                    fiftyFifty: 3,
                    skip: 3,
                    poll: 3,
                    addTime: 3
                };
                const numToShow = quizTitle === 'تحدي بوابة الجامعة' ? 1 : NUM_QUESTIONS_TO_SHOW;
                const shuffledTf = [...currentQuizData.tf_questions].sort(() => Math.random() - 0.5);
                const shuffledMc = [...currentQuizData.mc_questions].sort(() => Math.random() - 0.5);
                const allAvailableQuestions = shuffledMc.concat(shuffledTf);
                allQuestions = allAvailableQuestions.slice(0, numToShow);
                displayQuestion();
                if (quizModal) quizModal.classList.add('active');
            };
            startQuizBtn.addEventListener('click', startQuiz);
        }

        function unlockAudio() {
            if (isAudioUnlocked) return;
            const sounds = [correctSound, incorrectSound, transitionSound, guideAppearsSound, successSound];
            sounds.forEach(sound => {
                if (sound) {
                    sound.play().catch(() => {});
                    sound.pause();
                    sound.currentTime = 0;
                }
            });
            isAudioUnlocked = true;
            document.body.removeEventListener('click', unlockAudio);
        }
        document.body.addEventListener('click', unlockAudio);

        function playSound(soundElement) {
            if (isAudioUnlocked && soundElement) {
                soundElement.currentTime = 0;
                soundElement.play().catch(error => console.error("Audio Error:", error));
            }
        }

        function displayQuestion() {
            playSound(transitionSound);
            clearInterval(questionTimer);
            if (feedbackPopup) feedbackPopup.classList.remove('visible');
            const pollArea = document.getElementById('poll-results-area');
            if (pollArea) pollArea.style.display = 'none';
            if (currentQuestionIndex >= allQuestions.length) {
                displayResults();
                return;
            }
            const question = allQuestions[currentQuestionIndex];
            let optionsHTML = '';
            Object.keys(question.options).forEach(key => {
                optionsHTML += `<div class="quiz-option" data-key="${key}">${question.options[key]}</div>`;
            });
            if (quizBody) {
                quizBody.innerHTML = `
                <div class="quiz-container">
                    <div class="quiz-help-container">
                        <button class="help-button" id="help-fifty"> <div class="help-attempts-counter">${helpCounters.fiftyFifty}</div> <i class="fas fa-adjust"></i> <span>50/50</span> </button>
                        <button class="help-button" id="help-skip"> <div class="help-attempts-counter">${helpCounters.skip}</div> <i class="fas fa-forward"></i> <span>تخطّ</span> </button>
                        <button class="help-button" id="help-poll"> <div class="help-attempts-counter">${helpCounters.poll}</div> <i class="fas fa-chart-bar"></i> <span>جمهور</span> </button>
                        <button class="help-button" id="help-add-time"> <div class="help-attempts-counter">${helpCounters.addTime}</div> <i class="fas fa-stopwatch"></i> <span>+30 ث</span> </button>
                    </div>
                    <div class="quiz-main-container">
                        <div class="quiz-top-bar">
                            <p id="quiz-progress">سؤال ${currentQuestionIndex + 1} / ${allQuestions.length} | النقاط: ${score}</p>
                            <div id="quiz-progress-dots"></div>
                            <div id="quiz-timer">${TIME_PER_QUESTION}</div>
                        </div>
                        <div class="quiz-question-area"><p id="quiz-question-text">${question.question}</p></div>
                        <div id="poll-results-area"></div>
                        <div class="quiz-options-area">${optionsHTML}</div>
                    </div>
                </div>`;
            }
            updateProgressDots();
            addEventListeners();
            startTimer();
        }

        function updateProgressDots() {
            const dotsContainer = document.getElementById('quiz-progress-dots');
            if (dotsContainer) {
                dotsContainer.innerHTML = '';
                for (let i = 0; i < allQuestions.length; i++) {
                    const dot = document.createElement('div');
                    dot.classList.add('progress-dot');
                    if (i < currentQuestionIndex) {
                        dot.classList.add('completed');
                    } else if (i === currentQuestionIndex) {
                        dot.classList.add('current');
                    }
                    dotsContainer.appendChild(dot);
                }
            }
        }

        function processAnswer(selectedOption) {
            clearInterval(questionTimer);
            const question = allQuestions[currentQuestionIndex];
            const selectedKey = selectedOption.dataset.key;
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.classList.add('no-hover');
            });
            if (selectedKey === question.correctAnswer) {
                playSound(correctSound);
                score++;
                selectedOption.classList.add('correct');
                showFeedback(true, "إجابة رائعة!");
                if (typeof window.incrementMainScore === 'function') {
                    window.incrementMainScore(1);
                }
                const savedState = JSON.parse(localStorage.getItem('iugGameProgress'));
                if (savedState) {
                    const answered = new Set(savedState.answeredQuestions);
                    answered.add(question.id);
                    savedState.answeredQuestions = Array.from(answered);
                    localStorage.setItem('iugGameProgress', JSON.stringify(savedState));
                }
            } else {
                playSound(incorrectSound);
                const correctOptionEl = document.querySelector(`.quiz-option[data-key="${question.correctAnswer}"]`);
                if (correctOptionEl) correctOptionEl.classList.add('correct');
                selectedOption.classList.add('incorrect');
                showFeedback(false, "إجابة خاطئة!");
            }
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, FEEDBACK_DURATION);
        }

        function handleTimeOut() {
            playSound(incorrectSound);
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.classList.add('no-hover');
            });
            const correctOptionEl = document.querySelector(`.quiz-option[data-key="${allQuestions[currentQuestionIndex].correctAnswer}"]`);
            if (correctOptionEl) correctOptionEl.classList.add('correct');
            showFeedback(false, "انتهى الوقت!");
            setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
            }, FEEDBACK_DURATION);
        }

        function showFeedback(isCorrect, message) {
            if (!feedbackPopup || !feedbackContent) {
                console.error("Feedback popup elements not found!");
                return;
            }
            feedbackContent.classList.remove('correct', 'incorrect');
            if (feedbackHint) feedbackHint.innerHTML = '';
            if (feedbackMessage) feedbackMessage.textContent = '';
            playSound(guideAppearsSound);
            if (feedbackMessage) {
                feedbackMessage.textContent = message;
            }
            feedbackContent.classList.remove('correct', 'incorrect');
            if (isCorrect) {
                if (feedbackEmoji) feedbackEmoji.textContent = '✅';
                feedbackContent.classList.add('correct');
                if (feedbackHint) feedbackHint.innerHTML = '';
            } else {
                if (feedbackEmoji) feedbackEmoji.textContent = '🤔';
                feedbackContent.classList.add('incorrect');
                const currentQuestion = allQuestions[currentQuestionIndex];
                if (feedbackHint && currentQuestion.hint) {
                    feedbackHint.innerHTML = `💡 ${currentQuestion.hint}`;
                }
            }
            feedbackPopup.classList.add('visible');
        }

        function displayResults() {
            if (currentQuizTitle === 'تحدي بوابة الجامعة') {
                const isCorrect = score > 0;
                if (isCorrect) {
                    closeQuiz();
                    if (typeof window.onGateQuizSuccess === 'function') {
                        window.onGateQuizSuccess();
                    }
                    return;
                }
            }
            
            try {
                if (typeof window.finalizeQuizScore === 'function') {
                    window.finalizeQuizScore(currentQuizId, score, allQuestions.length);
                }
            } catch(e) { console.warn('finalizeQuizScore failed', e); }
            playSound(successSound);
            const percentage = allQuestions.length > 0 ? Math.round((score / allQuestions.length) * 100) : 0;
            let emoji, message;
            if (percentage >= 80) {
                emoji = '🎉';
                message = 'ممتاز! لديك معلومات رائعة.';
            } else if (percentage >= 50) {
                emoji = '👍';
                message = 'جيد جداً! أنت على الطريق الصحيح.';
            } else {
                emoji = '🤔';
                message = 'تحتاج إلى مراجعة معلوماتك أكثر.';
            }
            let restartButtonHTML = '';
            if (quizRestartAttempts > 0) {
                restartButtonHTML = `<button id="restart-quiz-btn" class="action-button">أعد التحدي (${quizRestartAttempts} فرصة متبقية)</button>`;
            } else {
                restartButtonHTML = `<button id="restart-quiz-btn" class="action-button" disabled>أعد التحدي (0 فرصة متبقية)</button>`;
            }
            if (quizBody) {
                quizBody.innerHTML = `
                <div class="quiz-results">
                    <h2>اكتمل التحدي!</h2>
                    <p id="score-emoji">${emoji}</p>
                    <p>نتيجتك هي: <strong>${score} من ${allQuestions.length} (${percentage}%)</strong></p>
                    <p>${message}</p>
                    <div id="quiz-controls">
                        ${restartButtonHTML}
                        <button id="close-quiz-btn" class="action-button">إغلاق النافذة</button>
                    </div>
                </div>`;
            }
            const restartBtn = document.getElementById('restart-quiz-btn');
            if (restartBtn) {
                restartBtn.addEventListener('click', () => {
                    if (quizRestartAttempts > 0) {
                        quizRestartAttempts--;
                        currentQuestionIndex = 0;
                        score = 0;
                        helpCounters = {
                            fiftyFifty: 3,
                            skip: 3,
                            poll: 3,
                            addTime: 3
                        };
                        const tfQuestions = currentQuizData.tf_questions.sort(() => Math.random() - 0.5).slice(0, Math.ceil(NUM_QUESTIONS_TO_SHOW / 2));
                        const mcQuestions = currentQuizData.mc_questions.sort(() => Math.random() - 0.5).slice(0, Math.floor(NUM_QUESTIONS_TO_SHOW / 2));
                        allQuestions = tfQuestions.concat(mcQuestions);
                        allQuestions.sort(() => Math.random() - 0.5);
                        displayQuestion();
                    }
                });
            }
            const backToMapBtn = document.getElementById('close-quiz-btn');
            if (backToMapBtn) {
                backToMapBtn.addEventListener('click', closeQuiz);
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('quiz-timer');
            if (!timerEl) return;
            timeLeft = TIME_PER_QUESTION;
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('low-time');
            questionTimer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 5) {
                    timerEl.classList.add('low-time');
                }
                if (timeLeft <= 0) {
                    clearInterval(questionTimer);
                    handleTimeOut();
                }
            }, 1000);
        }

        function addEventListeners() {
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', () => processAnswer(option));
            });
            setupHelpButton('help-fifty', useFiftyFifty);
            setupHelpButton('help-skip', useSkip);
            setupHelpButton('help-poll', useAudiencePoll);
            setupHelpButton('help-add-time', useAddTime);
        }

        function setupHelpButton(id, action) {
            const button = document.getElementById(id);
            if (!button) return;
            const key = id.replace('help-', '').replace(/-\w/g, m => m[1].toUpperCase());
            button.disabled = helpCounters[key] <= 0;
            button.addEventListener('click', function() {
                action.call(this);
            }, {
                once: true
            });
        }

        function useFiftyFifty() {
            if (helpCounters.fiftyFifty > 0) {
                helpCounters.fiftyFifty--;
                this.disabled = true;
                const counterEl = this.querySelector('.help-attempts-counter');
                if (counterEl) counterEl.textContent = helpCounters.fiftyFifty;
                const question = allQuestions[currentQuestionIndex];
                const incorrectOptions = Object.keys(question.options).filter(k => k !== question.correctAnswer);
                const toHideCount = incorrectOptions.length > 1 ? (incorrectOptions.length / 2) : 1;
                const toHide = incorrectOptions.sort(() => 0.5 - Math.random()).slice(0, toHideCount);
                toHide.forEach(key => {
                    const el = document.querySelector(`.quiz-option[data-key="${key}"]`);
                    if (el) el.classList.add('hidden');
                });
            }
        }

        function useSkip() {
            if (helpCounters.skip > 0) {
                helpCounters.skip--;
                const counterEl = document.querySelector('#help-skip .help-attempts-counter');
                if (counterEl) counterEl.textContent = helpCounters.skip;
                clearInterval(questionTimer);
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function useAddTime() {
            if (helpCounters.addTime > 0) {
                helpCounters.addTime--;
                this.disabled = true;
                const counterEl = this.querySelector('.help-attempts-counter');
                if (counterEl) counterEl.textContent = helpCounters.addTime;
                timeLeft += TIME_ADDITION;
                const timerEl = document.getElementById('quiz-timer');
                if (timerEl) timerEl.textContent = timeLeft;
            }
        }

        function useAudiencePoll() {
            if (helpCounters.poll > 0) {
                helpCounters.poll--;
                this.disabled = true;
                const counterEl = this.querySelector('.help-attempts-counter');
                if (counterEl) counterEl.textContent = helpCounters.poll;
                const question = allQuestions[currentQuestionIndex];
                const pollResults = generatePollResults(question);
                displayPollResults(pollResults, question.options);
            }
        }

        function generatePollResults(question) {
            const options = Object.keys(question.options);
            const correctAnswer = question.correctAnswer;
            let results = {};
            let remainingPercentage = 100;
            const correctAnswerPercentage = Math.floor(Math.random() * 26) + 60;
            results[correctAnswer] = correctAnswerPercentage;
            remainingPercentage -= correctAnswerPercentage;
            const incorrectOptions = options.filter(opt => opt !== correctAnswer);
            let randomValues = incorrectOptions.map(() => Math.random());
            const randomSum = randomValues.reduce((sum, val) => sum + val, 0);
            incorrectOptions.forEach((opt, index) => {
                const percentage = Math.round((randomValues[index] / randomSum) * remainingPercentage);
                results[opt] = percentage;
            });
            let finalSum = Object.values(results).reduce((sum, val) => sum + val, 0);
            if (finalSum !== 100 && incorrectOptions.length > 0) {
                results[incorrectOptions[0]] += (100 - finalSum);
            } else if (finalSum !== 100) {
                results[correctAnswer] += (100 - finalSum);
            }
            return results;
        }

        function displayPollResults(pollResults, optionsText) {
            const pollArea = document.getElementById('poll-results-area');
            if (!pollArea) return;
            let chartHTML = '<div class="poll-chart-container">';
            chartHTML += '<h3><i class="fas fa-chart-bar"></i> تصويت الجمهور</h3>';
            chartHTML += '<div class="poll-chart">';
            Object.keys(pollResults).forEach(key => {
                const percentage = pollResults[key];
                const optionLabel = optionsText[key];
                chartHTML += `
                <div class="poll-bar-wrapper">
                    <div class="poll-percentage">${percentage}%</div>
                    <div class="poll-bar" style="height: ${percentage}%;"></div>
                    <div class="poll-label">${optionLabel}</div>
                </div>
            `;
            });
            chartHTML += '</div></div>';
            pollArea.innerHTML = chartHTML;
            pollArea.style.display = 'block';
        }
        initializeQuiz('start-admission-quiz-btn', admissionQuizData, 'تحدي القبول');
        initializeQuiz('start-grants-quiz-btn', grantsQuizData, 'تحدي المنح');
        initializeQuiz('start-exchange-quiz-btn', exchangeQuizData, 'تحدي التبادل الأكاديمي');
        initializeQuiz('start-studentaffairs-quiz-btn', studentAffairsQuizData, 'تحدي شؤون الطلبة');
        initializeQuiz('start-library-quiz-btn', libraryQuizData, 'تحدي المكتبة');
        initializeQuiz('start-cafeteria-quiz-btn', cafeteriaQuizData, 'تحدي الكليات');
        initializeQuiz('start-faculties-quiz-btn', facultiesQuizData, 'تحدي الكليات');
        initializeQuiz('start-gate-quiz-btn', gateQuizData, 'تحدي بوابة الجامعة');
        const closeQuiz = () => {
            clearInterval(questionTimer);
            if (quizModal) quizModal.classList.remove('active');
             if(typeof checkAndAwardBadges === 'function') {
         if(typeof checkAndAwardBadges === 'function') {
        checkAndAwardBadges();
    }
    }
        };
        if (closeQuizModalBtn) {
            closeQuizModalBtn.addEventListener('click', closeQuiz);
        }
    });
}